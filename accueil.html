<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface Mobile Nescafé</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: white; min-height: 100vh; padding-bottom: 80px; }
        .image-carousel { position: relative; width: 100%; height: 200px; overflow: hidden; background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%); border-radius: 0 0 20px 20px; }
        .carousel-container { display: flex; width: 300%; height: 100%; animation: slide 12s infinite ease-in-out; }
        @keyframes slide { 0%, 30% { transform: translateX(0%); } 33%, 63% { transform: translateX(-33.33%); } 66%, 96% { transform: translateX(-66.66%); } 100% { transform: translateX(0%); } }
        .carousel-item { width: 33.33%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; background-size: cover; background-position: center; }
        .carousel-item:nth-child(1) { background: linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(160, 82, 45, 0.3)), url('https://image.noelshack.com/fichiers/2026/01/7/1767565966-file-000000008c507246beba20d6f11b51a8.jpg'); background-size: cover; background-position: center; }
        .carousel-item:nth-child(2) { background: linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(184, 134, 11, 0.3)), url('https://image.noelshack.com/fichiers/2026/01/7/1767566101-1713816392838.jpeg'); background-size: cover; background-position: center; }
        .carousel-item:nth-child(3) { background: linear-gradient(135deg, rgba(160, 82, 45, 0.3), rgba(139, 69, 19, 0.3)), url('https://image.noelshack.com/fichiers/2026/01/7/1767566270-kjc-1559-1.jpg'); background-size: cover; background-position: center; }
        .carousel-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2; }
        .nescafe-logo { font-size: 42px; font-weight: bold; color: white; text-shadow: 0 4px 8px rgba(0,0,0,0.3); margin-bottom: 8px; animation: fadeInOut 12s infinite; }
        .nescafe-tagline { font-size: 14px; color: rgba(255,255,255,0.95); text-shadow: 0 2px 4px rgba(0,0,0,0.3); animation: fadeInOut 12s infinite; }
        @keyframes fadeInOut { 0%, 30% { opacity: 1; } 31%, 32% { opacity: 0; } 33%, 63% { opacity: 1; } 64%, 65% { opacity: 0; } 66%, 96% { opacity: 1; } 97%, 100% { opacity: 0; } }
        .carousel-border { position: absolute; bottom: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #8B4513 0%, #D2691E 25%, #CD853F 50%, #DEB887 75%, #8B4513 100%); border-radius: 0 0 20px 20px; }
        .content { padding: 0; }
        .products-section { padding: 20px 0; }
        .section-title { font-size: 20px; font-weight: bold; color: #8B4513; padding: 0 15px 15px 15px; margin: 0; }
        .products-scroll { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 15px 20px 15px; }
        .product-card { background: white; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); }
        .product-image { height: 100px; display: flex; align-items: center; justify-content: center; background: #8B4513; }
        .product-name { font-size: 16px; font-weight: bold; color: #333; padding: 12px 12px 8px 12px; margin: 0; text-align: center; }
        .product-info { padding: 0 12px 12px 12px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; }
        .info-row .label { color: #666; font-weight: 500; }
        .info-row .value { color: #333; font-weight: 600; }
        .info-row .value.green { color: #4CAF50; }
        .info-row.total { border-top: 1px solid #e0e0e0; padding-top: 8px; margin-top: 8px; }
        .info-row.total .value { color: #8B4513; font-size: 14px; }
        .btn-buy { width: calc(100% - 24px); margin: 0 12px 12px 12px; padding: 10px; background: linear-gradient(135deg, #8B4513, #A0522D); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-buy:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4); }
        .btn-buy:disabled { background: #ccc; cursor: not-allowed; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex !important; }
        .modal-content { background: white; border-radius: 20px; padding: 25px; max-width: 350px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-title { font-size: 20px; font-weight: bold; color: #8B4513; margin: 0 0 20px 0; text-align: center; }
        .modal-body { margin-bottom: 20px; }
        .confirm-question { font-size: 15px; color: #333; margin: 0 0 15px 0; text-align: center; font-weight: 500; }
        .confirm-details { background: #f8f8f8; padding: 15px; border-radius: 12px; }
        .confirm-details h4 { font-size: 16px; color: #8B4513; margin: 0 0 10px 0; text-align: center; }
        .confirm-details p { font-size: 13px; margin: 6px 0; color: #333; }
        .modal-actions { display: flex; gap: 10px; }
        .btn-cancel, .btn-confirm { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-cancel { background: #e0e0e0; color: #666; }
        .btn-cancel:hover { background: #d0d0d0; }
        .btn-confirm { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
        .btn-confirm:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4); }
        .btn-confirm:disabled { background: #ccc; cursor: not-allowed; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; justify-content: space-around; align-items: center; padding: 8px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; border-top: 1px solid #e0e0e0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #666; padding: 4px 12px; transition: all 0.3s ease; cursor: pointer; }
        .nav-item.active { color: #667eea; }
        .nav-icon { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
        .nav-label { font-size: 11px; font-weight: 500; }
    </style>
</head>
<body>
    <div class="image-carousel">
        <div class="carousel-container">
            <div class="carousel-item"></div>
            <div class="carousel-item"></div>
            <div class="carousel-item"></div>
        </div>
        <div class="carousel-overlay">
            <div class="nescafe-logo">NESTCAFE</div>
            <div class="nescafe-tagline">☕ Savourez l'instant</div>
        </div>
        <div class="carousel-border"></div>
    </div>

    <div class="content">
        <div class="products-section">
            <h2 class="section-title">Produits d'Investissement NESTCAFE</h2>
            <div class="products-scroll" id="productsContainer">
                <!-- Les produits seront générés dynamiquement -->
            </div>
        </div>

        <div id="modal" class="modal">
            <div class="modal-content">
                <h3 class="modal-title">Confirmation d'achat</h3>
                <div class="modal-body">
                    <p class="confirm-question">Êtes-vous sûr d'acheter ce produit ?</p>
                    <div class="confirm-details">
                        <h4 id="modalVipBadge">Produits -A</h4>
                        <p><strong>Coût:</strong> <span id="modalAmount">5.500 FCFA</span></p>
                        <p><strong>Bénéfice journalier:</strong> <span id="modalDaily">1.250 FCFA</span></p>
                        <p><strong>Cycle:</strong> <span id="modalCycle">15 jours</span></p>
                        <p><strong>Bénéfices total:</strong> <span id="modalTotal">18.750 FCFA</span></p>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" id="btnCancel">Annuler</button>
                    <button class="btn-confirm" id="confirmBtn">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:15px 25px; border-radius:10px; z-index:3000; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,0.3);"></div>

    <nav class="bottom-nav">
        <a class="nav-item active" href="accueil.html"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span class="nav-label">Accueil</span></a>
        <a class="nav-item" href="machine.html"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg><span class="nav-label">Actifs</span></a>
        <a class="nav-item" href="equipe.html"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg><span class="nav-label">Partage</span></a>
        <a class="nav-item" href="solde.html"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg><span class="nav-label">Compte</span></a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getDatabase, ref, get, update, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATz_ogu08DUoKSYKy6t2cHWdleUD-Fbrk",
            authDomain: "schweppes-15df3.firebaseapp.com",
            databaseURL: "https://schweppes-15df3-default-rtdb.firebaseio.com",
            projectId: "schweppes-15df3",
            storageBucket: "schweppes-15df3.firebasestorage.app",
            messagingSenderId: "1011077098372",
            appId: "1:1011077098372:web:64f9ad3a8e93f68c070bd1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let currentUser = null;
        let currentSolde = 0;
        let currentProduct = null;

        // Configuration des produits
        const PRODUCT_CONFIG = {
            1: { 
                productId: 1, 
                nom: "Produits -A", 
                price: 5500, 
                dailyRevenue: 1250, 
                cycleDuration: 15, 
                totalRevenue: 18750, 
                limit: 1,
                image: "https://image.noelshack.com/fichiers/2026/01/7/1767566579-714fmrtnyel-sl1500.jpg",
                gradient: "linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(160, 82, 45, 0.3))"
            },
            2: { 
                productId: 2, 
                nom: "Produits -B", 
                price: 10500, 
                dailyRevenue: 2500, 
                cycleDuration: 15, 
                totalRevenue: 37500, 
                limit: 1,
                image: "https://image.noelshack.com/fichiers/2026/01/7/1767566989-1.jpg",
                gradient: "linear-gradient(135deg, rgba(205, 133, 63, 0.3), rgba(222, 184, 135, 0.3))"
            },
            3: { 
                productId: 3, 
                nom: "Produits -C", 
                price: 25000, 
                dailyRevenue: 4000, 
                cycleDuration: 15, 
                totalRevenue: 60000, 
                limit: 1,
                image: "https://image.noelshack.com/fichiers/2026/01/7/1767567329-chocolat-en-poudre-avec-feves-de-cacao-nestle-324x389.jpg",
                gradient: "linear-gradient(135deg, rgba(210, 105, 30, 0.3), rgba(255, 140, 0, 0.3))"
            },
            4: { 
                productId: 4, 
                nom: "Produits -D", 
                price: 50000, 
                dailyRevenue: 8500, 
                cycleDuration: 15, 
                totalRevenue: 127500, 
                limit: 1,
                image: "https://image.noelshack.com/fichiers/2026/01/7/1767567532-chocolat-en-poudre-cacaote-et-malte-tonimalt-324x389.jpg",
                gradient: "linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(101, 67, 33, 0.3))"
            },
            5: { 
                productId: 5, 
                nom: "Produits -E", 
                price: 100000, 
                dailyRevenue: 25500, 
                cycleDuration: 15, 
                totalRevenue: 382500, 
                limit: 2,
                image: "https://image.noelshack.com/fichiers/2026/02/1/1767567825-images-2.jpeg",
                gradient: "linear-gradient(135deg, rgba(160, 82, 45, 0.3), rgba(139, 69, 19, 0.3))"
            },
            6: { 
                productId: 6, 
                nom: "VIP 6", 
                price: 200000, 
                dailyRevenue: 51000, 
                cycleDuration: 15, 
                totalRevenue: 765000, 
                limit: 2,
                image: "https://image.noelshack.com/fichiers/2026/02/1/1767568039-cafe-soluble-viennois-nescafe-324x389.jpg",
                gradient: "linear-gradient(135deg, rgba(210, 105, 30, 0.3), rgba(184, 134, 11, 0.3))"
            }
        };

        const formatCurrency = (n) => Number(n).toLocaleString("fr-FR") + " FCFA";

        function showNotification(message, type = "success") {
            const n = document.getElementById("notification");
            n.textContent = message;
            n.style.background = type === "success" ? "#10b981" : "#ef4444";
            n.style.display = "block";
            setTimeout(() => n.style.display = "none", 4000);
        }

        function setupBalanceListener(uid) {
            onValue(ref(db, `users/${uid}/balance`), snap => { 
                currentSolde = Number(snap.val() || 0); 
            });
        }

        async function checkActiveInvestments(uid, productId) {
            const snap = await get(ref(db, `investments/${uid}`));
            if (!snap.exists()) return 0;
            let count = 0;
            Object.values(snap.val()).forEach(inv => {
                if (inv.productId === productId && inv.status === "active" && inv.remainingDays > 0) count++;
            });
            return count;
        }

        function openModal(productId) {
            currentProduct = PRODUCT_CONFIG[productId];
            console.log("Opening modal for product:", currentProduct);
            
            document.getElementById("modalVipBadge").textContent = currentProduct.nom;
            document.getElementById("modalAmount").textContent = formatCurrency(currentProduct.price);
            document.getElementById("modalDaily").textContent = formatCurrency(currentProduct.dailyRevenue);
            document.getElementById("modalCycle").textContent = currentProduct.cycleDuration + " jours";
            document.getElementById("modalTotal").textContent = formatCurrency(currentProduct.totalRevenue);
            
            const modal = document.getElementById("modal");
            modal.classList.add("active");
            console.log("Modal classes:", modal.className);
        }

        function closeModal() {
            document.getElementById("modal").classList.remove("active");
            currentProduct = null;
        }

        function investProduct(productId) {
            console.log("Invest product called:", productId);
            
            if (!currentUser) {
                showNotification("Veuillez vous connecter", "error");
                return;
            }
            
            const product = PRODUCT_CONFIG[productId];
            if (currentSolde < product.price) {
                showNotification("Solde insuffisant", "error");
                return;
            }
            
            openModal(productId);
        }

        async function confirmInvestment() {
            if (!currentUser || !currentProduct) return;
            const btn = document.getElementById("confirmBtn");
            btn.disabled = true;
            
            try {
                const active = await checkActiveInvestments(currentUser.uid, currentProduct.productId);
                if (active >= currentProduct.limit) {
                    showNotification("Limite atteinte", "error");
                    closeModal();
                    return;
                }

                const newBalance = currentSolde - currentProduct.price;
                const now = new Date();
                const updates = {};
                updates[`users/${currentUser.uid}/balance`] = newBalance;

                const invRef = push(ref(db, `investments/${currentUser.uid}`));
                updates[`investments/${currentUser.uid}/${invRef.key}`] = {
                    productId: currentProduct.productId,
                    productName: currentProduct.nom,
                    amount: currentProduct.price,
                    dailyRevenue: currentProduct.dailyRevenue,
                    totalRevenue: currentProduct.totalRevenue,
                    remainingDays: currentProduct.cycleDuration,
                    startDate: now.toISOString(),
                    status: "active",
                    totalCollected: 0,
                    lastCollection: now.toISOString(),
                    timestamp: serverTimestamp()
                };

                await update(ref(db), updates);
                showNotification("Investissement activé avec succès");
                closeModal();
                updateInvestmentLimits(currentUser.uid);
                setTimeout(() => location.href = "machine.html", 2000);
            } catch (e) {
                console.error(e);
                showNotification("Erreur serveur", "error");
            } finally {
                btn.disabled = false;
            }
        }

        async function updateInvestmentLimits(uid) {
            for (const id in PRODUCT_CONFIG) {
                const product = PRODUCT_CONFIG[id];
                const active = await checkActiveInvestments(uid, product.productId);
                const btn = document.getElementById(`btn${id}`);
                if (!btn) continue;
                if (active >= product.limit) {
                    btn.disabled = true;
                    btn.textContent = 'Limite atteinte';
                } else {
                    btn.disabled = false;
                    btn.textContent = 'Acheter';
                }
            }
        }

        function renderProducts() {
            const container = document.getElementById("productsContainer");
            container.innerHTML = "";
            
            for (const id in PRODUCT_CONFIG) {
                const product = PRODUCT_CONFIG[id];
                const card = document.createElement("div");
                card.className = "product-card";
                card.innerHTML = `
                    <div class="product-image" style="background: ${product.gradient}, url('${product.image}'); background-size: cover; background-position: center;"></div>
                    <h3 class="product-name">${product.nom}</h3>
                    <div class="product-info">
                        <div class="info-row"><span class="label">Coût:</span><span class="value">${formatCurrency(product.price)}</span></div>
                        <div class="info-row"><span class="label">Bénéfice :</span><span class="value green">${formatCurrency(product.dailyRevenue)}</span></div>
                        <div class="info-row"><span class="label">Cycle:</span><span class="value">${product.cycleDuration} jours</span></div>
                        <div class="info-row total"><span class="label">Total:</span><span class="value">${formatCurrency(product.totalRevenue)}</span></div>
                    </div>
                    <button class="btn-buy" id="btn${id}">Acheter</button>
                `;
                container.appendChild(card);
            }
            
            // Ajouter les événements après que tous les boutons soient créés
            for (const id in PRODUCT_CONFIG) {
                const btn = document.getElementById(`btn${id}`);
                if (btn) {
                    btn.addEventListener('click', function() {
                        investProduct(parseInt(id));
                    });
                }
            }
        }

        // Événements du modal
        document.getElementById("btnCancel").addEventListener('click', closeModal);
        document.getElementById("confirmBtn").addEventListener('click', confirmInvestment);

        // Initialisation
        renderProducts();

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                setupBalanceListener(user.uid);
                updateInvestmentLimits(user.uid);
            } else {
                currentUser = null;
                currentSolde = 0;
            }
        });
    </script>
</body>
</html>
