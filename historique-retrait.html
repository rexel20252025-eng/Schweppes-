<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historique de Retrait - NESTCAFE</title>
<style>
body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background: #ffffff; color:#333; margin:0; padding:0; }
.header { display:flex; align-items:center; margin-bottom:15px; padding:12px; border-bottom:2px solid #e0e0e0; background: #ffffff; }
.back-arrow { font-size:20px; cursor:pointer; margin-right:12px; color:#8B4513; transition: color 0.3s; }
.back-arrow:hover { color:#d2691e; }
.header-title { font-size:16px; font-weight:600; color:#8B4513; }

#history-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 0 10px;
}

.card {
    background: linear-gradient(135deg, #f5ebe0 0%, #ecddd0 100%);
    border:1px solid #d2b48c;
    border-radius:10px;
    padding:10px 12px;
    margin:8px 0;
    box-shadow:0 2px 8px rgba(139,69,19,0.15);
    transition: box-shadow 0.3s, transform 0.2s;
    display: flex;
    gap: 12px;
}

.card:hover { box-shadow:0 4px 12px rgba(139,69,19,0.25); transform:translateY(-2px); }

.operator-logo-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    gap: 5px;
}

.nestcafe-logo {
    width: 35px;
    height: 35px;
    object-fit: contain;
    border-radius: 6px;
    background: #fff;
    padding: 3px;
    box-shadow: 0 1px 4px rgba(139,69,19,0.2);
    border: 1.5px solid #8B4513;
}

.transfer-arrow {
    font-size: 16px;
    color: #8B4513;
    margin: 1px 0;
}

.transfer-status {
    font-size: 9px;
    font-weight: 600;
    color: #8B4513;
    text-align: center;
    padding: 2px 5px;
    border-radius: 6px;
    background: #fff3cd;
    white-space: nowrap;
    max-width: 85px;
    line-height: 1.2;
}

.transfer-status.paid {
    background: #d4edda;
    color: #155724;
}

.operator-logo {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 6px;
    background: #fff;
    padding: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.operator-name {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    color: #8B4513;
    letter-spacing: 0.3px;
    text-align: center;
    background: linear-gradient(135deg, #f5deb3 0%, #d2b48c 100%);
    padding: 2px 6px;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(139,69,19,0.15);
    white-space: nowrap;
}

.card-content {
    flex: 1;
}

.row { display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px solid #f5e6d3; }
.row:last-child { border-bottom:none; }
.label { font-size:12px; color:#8B4513; font-weight:500; }
.value { font-size:12px; color:#333; font-weight:600; text-align:right; }
.value.red { color:#dc3545; }
.value.green { color:#28a745; }

.badge { padding:2px 8px; border-radius:15px; font-size:10px; font-weight:600; text-transform:capitalize; }
.badge-success { background-color:#d4edda; color:#155724; }
.badge-pending { background-color:#fff3cd; color:#856404; }
.badge-failed { background-color:#f8d7da; color:#721c24; }

.no-history { text-align:center; padding:40px 20px; color:#999; font-size:16px; }
</style>
</head>
<body>
<div class="header">
<span class="back-arrow" onclick="history.back()">←</span>
<div class="header-title">NESTCAFE - Historique de retrait</div>
</div>

<div id="history-container">
<div class="no-history">Chargement...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyATz_ogu08DUoKSYKy6t2cHWdleUD-Fbrk",
  authDomain: "schweppes-15df3.firebaseapp.com",
  databaseURL: "https://schweppes-15df3-default-rtdb.firebaseio.com",
  projectId: "schweppes-15df3",
  storageBucket: "schweppes-15df3.firebasestorage.app",
  messagingSenderId: "1011077098372",
  appId: "1:1011077098372:web:64f9ad3a8e93f68c070bd1"
};

// --- LOGOS DES OPÉRATEURS ---
const OPERATOR_LOGOS = {
    'wave': 'https://image.noelshack.com/fichiers/2026/03/1/1768220072-images.png',
    'orange': 'https://image.noelshack.com/fichiers/2026/03/1/1768221402-orange-logo.png',
    'mtn': 'https://image.noelshack.com/fichiers/2026/03/1/1768221455-mtn-ci.jpg',
    'moov': 'https://image.noelshack.com/fichiers/2026/03/1/1768221529-images-1.png',
    'airtel': 'https://example.com/airtel-logo.png'
};

// --- LOGO NESTCAFE ---
const NESTCAFE_LOGO = 'https://image.noelshack.com/fichiers/2026/03/6/1768668863-cafe-soluble-decafeine-nescafe-classic-10-sachets-nestle.jpg';

// --- Init Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// --- Utils ---
function formatCurrency(amount) {
    return Math.round(amount).toLocaleString() + ' FCFA';
}

function formatDate(ts) {
    if(!ts) return "Date inconnue";
    const time = Number(ts);
    const date = new Date(time);
    return date.toLocaleString('fr-FR', {
        day:'2-digit',
        month:'2-digit',
        year:'numeric',
        hour:'2-digit',
        minute:'2-digit'
    });
}

function statusBadge(status) {
    const s = (status || '').toLowerCase();
    if(s === 'success' || s === 'payé' || s === 'succès' || s === 'terminé')
        return `<span class="badge badge-success">${status}</span>`;
    if(s === 'pending' || s === 'en attente' || s === 'traitement bancaire')
        return `<span class="badge badge-pending">${status}</span>`;
    return `<span class="badge badge-failed">${status}</span>`;
}

function getOperatorLogo(operator, status) {
    if(!operator) return '';
    
    // Normaliser le nom de l'opérateur en minuscules
    const operatorKey = operator.toLowerCase().trim();
    
    // Chercher le logo correspondant
    const logoUrl = OPERATOR_LOGOS[operatorKey];
    
    // Déterminer le texte du statut de transfert
    const s = (status || '').toLowerCase();
    const isPaid = s === 'success' || s === 'payé' || s === 'succès' || s === 'terminé';
    const transferText = isPaid ? 'Transfert terminé' : 'Transfert en cours';
    const statusClass = isPaid ? 'paid' : '';
    
    // Vérifier si le logo existe et n'est pas un placeholder
    if(logoUrl && !logoUrl.includes('example.com')) {
        return `
        <div class="operator-logo-container">
            <img src="${NESTCAFE_LOGO}" alt="NESTCAFE" class="nestcafe-logo">
            <div class="transfer-arrow">↓</div>
            <div class="transfer-status ${statusClass}">${transferText}</div>
            <div class="transfer-arrow">↓</div>
            <img src="${logoUrl}" alt="${operator}" class="operator-logo" onerror="this.parentElement.style.display='none'">
            <span class="operator-name">${operator}</span>
        </div>`;
    }
    
    // Si pas de logo, on n'affiche rien
    return '';
}

function createWithdrawalCard(w) {
    const amt = formatCurrency(w.amount || 0);
    const fees = formatCurrency(w.fees || 0);
    const net = formatCurrency((w.amount || 0) - (w.fees || 0));
    const dateStr = formatDate(w.timestamp || w.date || w.order || Date.now());
    const operatorLogo = getOperatorLogo(w.operator, w.status);

    return `
    <div class="card">
        ${operatorLogo}
        <div class="card-content">
            <div class="row"><span class="label">Montant retiré :</span><span class="value red">− ${amt}</span></div>
            <div class="row"><span class="label">Frais d'opération :</span><span class="value red">− ${fees}</span></div>
            <div class="row"><span class="label">Montant à recevoir :</span><span class="value green">${net}</span></div>
            <div class="row"><span class="label">Statut :</span><span class="value">${statusBadge(w.status)}</span></div>
            <div class="row"><span class="label">Date de retrait :</span><span class="value">${dateStr}</span></div>
        </div>
    </div>`;
}

// --- Display history ---
function displayWithdrawalHistory(history){
    const container = document.getElementById('history-container');
    if(!history || Object.keys(history).length === 0){
        container.innerHTML = '<div class="no-history">Aucun retrait disponible</div>';
        return;
    }
    container.innerHTML = '';

    Object.entries(history)
        .sort(([, a], [, b]) => {
            const aTime = a.timestamp 
                ? Number(a.timestamp)
                : (a.date ? Number(a.date)
                : (a.order ? Number(a.order) : 0));

            const bTime = b.timestamp 
                ? Number(b.timestamp)
                : (b.date ? Number(b.date)
                : (b.order ? Number(b.order) : 0));

            return bTime - aTime;
        })
        .forEach(([, w]) => {
            container.innerHTML += createWithdrawalCard(w);
        });
}

// --- Auth ---
onAuthStateChanged(auth, user => {
    if(user){
        const historyRef = ref(db, `users/${user.uid}/withdrawalHistory`);
        onValue(historyRef, snapshot => {
            displayWithdrawalHistory(snapshot.val());
        });
    } else {
        window.location.href = 'login.html';
    }
});

// --- Back button ---
document.querySelector('.back-arrow')?.addEventListener('click', () => history.back());
</script>

</body>
</html>
