<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historique de Retrait - Schweppes</title>
<style>
body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif; background:#fff; color:#333; margin:0; padding:0; }
.header { display:flex; align-items:center; margin-bottom:20px; padding:15px; border-bottom:2px solid #f0f0f0; }
.back-arrow { font-size:24px; cursor:pointer; margin-right:15px; color:#666; transition: color 0.3s; }
.back-arrow:hover { color:#000; }
.header-title { font-size:18px; font-weight:600; color:#333; }

#history-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 0 10px;
}

.card {
    background:#fff;
    border:1px solid #e5e5e5;
    border-radius:12px;
    padding:12px 15px;
    margin:10px 0;
    box-shadow:0 1px 4px rgba(0,0,0,0.04);
    transition: box-shadow 0.3s, transform 0.2s;
}

.card:hover { box-shadow:0 2px 6px rgba(0,0,0,0.08); transform:translateY(-1px); }

.row { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid #f5f5f5; }
.row:last-child { border-bottom:none; }
.label { font-size:14px; color:#666; font-weight:500; }
.value { font-size:14px; color:#333; font-weight:600; text-align:right; }

.badge { padding:3px 10px; border-radius:20px; font-size:12px; font-weight:600; text-transform:capitalize; }
.badge-success { background-color:#d4edda; color:#155724; }
.badge-pending { background-color:#fff3cd; color:#856404; }
.badge-failed { background-color:#f8d7da; color:#721c24; }

.no-history { text-align:center; padding:40px 20px; color:#999; font-size:16px; }
</style>
</head>
<body>
<div class="header">
<span class="back-arrow" onclick="history.back()">←</span>
<div class="header-title">Schweppes - Historique de retrait</div>
</div>

<div id="history-container">
<div class="no-history">Chargement...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyATz_ogu08DUoKSYKy6t2cHWdleUD-Fbrk",
  authDomain: "schweppes-15df3.firebaseapp.com",
  databaseURL: "https://schweppes-15df3-default-rtdb.firebaseio.com",
  projectId: "schweppes-15df3",
  storageBucket: "schweppes-15df3.firebasestorage.app",
  messagingSenderId: "1011077098372",
  appId: "1:1011077098372:web:64f9ad3a8e93f68c070bd1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const USD_TO_FCFA = 587;

function formatDualCurrency(amountFCFA) {
    const usd = (amountFCFA / USD_TO_FCFA).toFixed(2);
    return { fcfa: Math.round(amountFCFA).toLocaleString(), usd: parseFloat(usd).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}) };
}

function formatDate(timestamp) {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(timestamp).toLocaleDateString('fr-FR', options);
}

function getStatusBadge(status) {
    const s = (status || '').toLowerCase();
    if(s === 'success' || s === 'succès') return '<span class="badge badge-success">Succès</span>';
    if(s === 'pending' || s === 'en attente' || s === 'traitement bancaire') return '<span class="badge badge-pending">En traitement</span>';
    if(s === 'failed' || s === 'échoué') return '<span class="badge badge-failed">Échoué</span>';
    return `<span class="badge badge-pending">${status || 'Inconnu'}</span>`;
}

function displayWithdrawalHistory(userId) {
    const withdrawalsRef = ref(db, `users/${userId}/withdrawalHistory`);
    onValue(withdrawalsRef, snapshot => {
        const container = document.getElementById('history-container');
        container.innerHTML = '';
        const history = snapshot.val();
        if(!history) {
            container.innerHTML = '<div class="no-history">Aucun retrait effectué.</div>';
            return;
        }

        Object.values(history).forEach(w => {
            const fees = w.fees || 0;
            const net = (w.amount || 0) - fees;
            const amt = formatDualCurrency(w.amount || 0);
            const feesFmt = formatDualCurrency(fees);
            const netFmt = formatDualCurrency(net);
            const dateStr = formatDate(w.date || Date.now());
            const statusBadge = getStatusBadge(w.status);

            const div = document.createElement('div');
            div.classList.add('card');
            div.innerHTML = `
                <div class="row"><span class="label">Montant retirer :</span><span class="value">- ${amt.fcfa} FCFA / $${amt.usd}</span></div>
                <div class="row"><span class="label">Frais d'opération :</span><span class="value">- ${feesFmt.fcfa} FCFA / $${feesFmt.usd}</span></div>
                <div class="row"><span class="label">Montant à recevoir :</span><span class="value">${netFmt.fcfa} FCFA / $${netFmt.usd}</span></div>
                <div class="row"><span class="label">Statut :</span><span class="value">${statusBadge}</span></div>
                <div class="row"><span class="label">Date :</span><span class="value">${dateStr}</span></div>
            `;
            container.appendChild(div);
        });
    });
}

onAuthStateChanged(auth, user => {
    if(user) {
        displayWithdrawalHistory(user.uid);
    } else {
        const container = document.getElementById('history-container');
        container.innerHTML = '<div class="no-history">Aucun retrait.</div>';
    }
});
</script>
</body>
</html>
