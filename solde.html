<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface Mobile</title>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: #f8f9fa;
    min-height: 100vh;
    padding-bottom: 80px;
}

.content {
    padding: 0;
    max-width: 480px;
    margin: 0 auto;
}

.palette-card {
    background: white;
    padding: 15px 20px;
    color: #1f2937;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border-radius: 0 0 20px 20px;
    border: 1px solid #e5e7eb;
    position: relative;
    overflow: hidden;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    position: relative;
    z-index: 1;
}

.user-logo {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    color: white;
    border: 2px solid #e0e7ff;
    box-shadow: 0 3px 10px rgba(99, 102, 241, 0.3);
}

.user-details {
    flex: 1;
}

.user-name {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 2px;
    letter-spacing: -0.2px;
    color: #1f2937;
}

.user-id {
    font-size: 11px;
    opacity: 0.6;
    font-weight: 500;
    color: #6b7280;
}

.balance-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    position: relative;
    z-index: 1;
}

.balance-item {
    background: white;
    border-radius: 14px;
    padding: 12px;
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.balance-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #d1d5db;
}

.balance-label {
    font-size: 10px;
    opacity: 0.7;
    margin-bottom: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: #6b7280;
    position: relative;
    z-index: 1;
}

.balance-amount {
    font-size: 17px;
    font-weight: 900;
    letter-spacing: 0.5px;
    color: #1f2937;
    position: relative;
    z-index: 1;
    display: flex;
    align-items: baseline;
    gap: 4px;
}

.balance-count {
    font-size: 9px;
    opacity: 0.65;
    margin-top: 4px;
    font-weight: 500;
    color: #9ca3af;
    position: relative;
    z-index: 1;
}

.action-buttons {
    padding: 12px 20px;
    display: flex;
    gap: 10px;
}

.btn-action {
    flex: 1;
    padding: 13px;
    border: none;
    border-radius: 14px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    text-decoration: none;
    color: white;
}

.btn-icon {
    width: 18px;
    height: 18px;
    fill: white;
}

.btn-recharge {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.btn-recharge:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.35);
}

.btn-retrait {
    background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
    color: white;
}

.btn-retrait:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(244, 63, 94, 0.35);
}

.menu-list {
    padding: 5px 20px 15px 20px;
}

.menu-item {
    background: white;
    border: none;
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    text-decoration: none;
}

.menu-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.menu-icon {
    width: 26px;
    height: 26px;
}

.menu-item:nth-child(1) .menu-icon { fill: #8b5cf6; }
.menu-item:nth-child(1):hover { background: rgba(139, 92, 246, 0.05); }
.menu-item:nth-child(2) .menu-icon { fill: #ec4899; }
.menu-item:nth-child(2):hover { background: rgba(236, 72, 153, 0.05); }
.menu-item:nth-child(3) .menu-icon { fill: #3b82f6; }
.menu-item:nth-child(3):hover { background: rgba(59, 130, 246, 0.05); }
.menu-item:nth-child(4) .menu-icon { fill: #f59e0b; }
.menu-item:nth-child(4):hover { background: rgba(245, 158, 11, 0.05); }

.menu-text {
    flex: 1;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    color: #1f2937;
}

.menu-arrow {
    width: 18px;
    height: 18px;
    fill: #9ca3af;
    transition: transform 0.3s ease;
}

.menu-item:hover .menu-arrow {
    transform: translateX(4px);
}

.btn-download {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 18px;
    width: 100%;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
    transition: all 0.3s ease;
    margin-bottom: 10px;
    text-decoration: none;
}

.btn-download:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
}

.download-icon {
    width: 22px;
    height: 22px;
    fill: white;
}

.btn-logout {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 16px;
    padding: 18px;
    width: 100%;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
    transition: all 0.3s ease;
    margin-top: 10px;
}

.btn-logout:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
}

.logout-icon {
    width: 22px;
    height: 22px;
    fill: white;
}

.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 8px 0;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #666;
    padding: 4px 12px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.nav-item.active {
    color: #667eea;
}

.nav-icon {
    width: 24px;
    height: 24px;
    margin-bottom: 4px;
}

.nav-label {
    font-size: 11px;
    font-weight: 500;
}

.icon-home { fill: currentColor; }
.icon-dashboard { fill: currentColor; }
.icon-share { fill: currentColor; }
.icon-account { fill: currentColor; }
    </style>
</head>
<body>
    <div class="content">
        <div class="palette-card">
            <div class="money-bg">
              
            </div>
            
            <div class="user-info">
                <div class="user-logo">üë§</div>
                <div class="user-details">
                    <div class="user-name">Utilisateur :  <span id="user-name">Chargement</span></div>
                    <div class="user-id">Identifiant NESTCAFE : <span id="user-id">xxxxxxxx</span></div>
                </div>
            </div>

            <div class="balance-grid">
                <div class="balance-item">
                    <div class="balance-label">Solde principal</div>
                    <div class="balance-amount" id="main-balance">0 FCFA</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">Total de recharge</div>
                    <div class="balance-amount" id="total-recharge">0 FCFA</div>
                    <div class="balance-count" id="recharge-count">0 recharge</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">Total de retrait</div>
                    <div class="balance-amount" id="total-withdrawals">0 FCFA</div>
                    <div class="balance-count" id="withdrawal-count">0 retrait</div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">Total de b√©n√©fice</div>
                    <div class="balance-amount" id="total-revenue">0 FCFA</div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <a href="recharge.html" class="btn-action btn-recharge">
                <svg class="btn-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                </svg>
                Recharge
            </a>
            <a href="retrait.html" class="btn-action btn-retrait">
                <svg class="btn-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z"/>
                </svg>
                Retrait
            </a>
        </div>

        <div class="menu-list">
            <a href="historique.html" class="menu-item">
                <svg class="menu-icon" viewBox="0 0 24 24">
                    <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                </svg>
                <span class="menu-text">Historique de recharge</span>
                <svg class="menu-arrow" viewBox="0 0 24 24">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </a>

            <a href="historique-retrait.html" class="menu-item">
                <svg class="menu-icon" viewBox="0 0 24 24">
                    <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                </svg>
                <span class="menu-text">Historique de retrait</span>
                <svg class="menu-arrow" viewBox="0 0 24 24">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </a>

            <a href="service-client.html" class="menu-item">
                <svg class="menu-icon" viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 9h-2V5h2v6zm0 4h-2v-2h2v2z"/>
                </svg>
                <span class="menu-text">Service client</span>
                <svg class="menu-arrow" viewBox="0 0 24 24">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </a>

            <a href="roue-fortune.html" class="menu-item">
                <svg class="menu-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/>
                </svg>
                <span class="menu-text">Roue de la fortune</span>
                <svg class="menu-arrow" viewBox="0 0 24 24">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </a>

            <a href="portefeuille.html" class="menu-item">
                <svg class="menu-icon" viewBox="0 0 24 24">
                    <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                </svg>
                <span class="menu-text">Compte de retrait</span>
                <svg class="menu-arrow" viewBox="0 0 24 24">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </a>

            <a href="carte.html" class="menu-item">
                <svg class="menu-icon" viewBox="0 0 24 24">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                </svg>
                <span class="menu-text">Veuillez v√©rifier votre compte li√©</span>
                <svg class="menu-arrow" viewBox="0 0 24 24">
                    <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                </svg>
            </a>

            <a href="https://appsgeyser.io/19405840/Nestcafe" target="_blank" class="btn-download">
                <svg class="download-icon" viewBox="0 0 24 24">
                    <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/>
                </svg>
                T√©l√©charger l'application NESTCAFE
            </a>

            <button class="btn-logout" id="logout-btn">
                <svg class="logout-icon" viewBox="0 0 24 24">
                    <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                </svg>
                D√©connexion
            </button>
        </div>
    </div>

    <nav class="bottom-nav">
        <a class="nav-item active" data-page="accueil" href="accueil.html">
            <svg class="nav-icon icon-home" viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
            <span class="nav-label">Accueil</span>
        </a>

        <a class="nav-item" data-page="actifs" href="machine.html">
            <svg class="nav-icon icon-dashboard" viewBox="0 0 24 24">
                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
            <span class="nav-label">Actifs</span>
        </a>

        <a class="nav-item" data-page="partage" href="equipe.html">
            <svg class="nav-icon icon-share" viewBox="0 0 24 24">
                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
            </svg>
            <span class="nav-label">Partage</span>
        </a>

        <a class="nav-item" data-page="compte" href="solde.html">
            <svg class="nav-icon icon-account" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
            <span class="nav-label">Compte</span>
        </a>
    </nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        onAuthStateChanged, 
        signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { 
        getDatabase, 
        ref, 
        set, 
        get, 
        onValue
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyATz_ogu08DUoKSYKy6t2cHWdleUD-Fbrk",
        authDomain: "schweppes-15df3.firebaseapp.com",
        databaseURL: "https://schweppes-15df3-default-rtdb.firebaseio.com",
        projectId: "schweppes-15df3",
        storageBucket: "schweppes-15df3.firebasestorage.app",
        messagingSenderId: "1011077098372",
        appId: "1:1011077098372:web:64f9ad3a8e93f68c070bd1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    let currentUser = null;

    class Utils {
        static generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            return Array.from({ length: 6 }, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
        }

        static async checkReferralCode(code) {
            if (!code) return null;
            const snapshot = await get(ref(db, 'users'));
            if (snapshot.exists()) {
                const users = snapshot.val();
                for (const userId in users) {
                    if (users[userId].referralCode === code) {
                        return { userId, username: users[userId].username };
                    }
                }
            }
            return null;
        }

        static showError(elementId, message) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = message;
                el.style.display = message ? 'block' : 'none';
            }
        }

        static showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = message;
                el.style.display = message ? 'block' : 'none';
            }
        }

        static clearMessages() {
            ['loginError', 'signupError', 'signupSuccess', 'referralStatus'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = '';
                    el.style.display = 'none';
                    el.className = el.className.replace(/(valid|invalid)/g, '').trim();
                }
            });
        }

        static updateReferralStatus(isValid, message) {
            const el = document.getElementById('referralStatus');
            if (el) {
                el.textContent = message;
                el.className = `referral-status ${isValid ? 'valid' : 'invalid'}`;
                el.style.display = message ? 'block' : 'none';
            }
        }

        static updateUserDisplay(userData) {
            const nameEl = document.getElementById('user-name');
            if (nameEl && userData?.username) nameEl.textContent = `${userData.username}`;

            const idEl = document.getElementById('user-id');
            if (idEl && userData?.phoneNumber) idEl.textContent = userData.phoneNumber;

            const emailEl = document.getElementById('user-email');
            if (emailEl && userData?.phoneNumber) emailEl.textContent = `${userData.phoneNumber}@temp.com`;
        }

        static formatCurrency(amountFCFA) {
            return Math.round(amountFCFA).toLocaleString() + ' FCFA';
        }

        static updateBalanceDisplay(elementId, amountFCFA) {
            const el = document.getElementById(elementId);
            if (el && amountFCFA !== undefined) {
                el.textContent = this.formatCurrency(amountFCFA);
            }
        }
    }

    class FormManager {
        static async handleSignup(event) {
            event.preventDefault();
            Utils.clearMessages();

            try {
                const username = document.getElementById("signupUsername").value.trim();
                const telephone = document.getElementById("signupTelephone").value.trim();
                const password = document.getElementById("signupPassword").value;
                const confirmPassword = document.getElementById("confirmPassword").value;
                const referralCode = document.getElementById("referralCode")?.value.trim();

                if (!username || !telephone || !password) throw new Error("Veuillez remplir tous les champs requis");
                if (password !== confirmPassword) throw new Error("Les mots de passe ne correspondent pas");
                if (password.length < 6) throw new Error("Le mot de passe doit contenir au moins 6 caract√®res");
                if (telephone.length < 8) throw new Error("Num√©ro de t√©l√©phone invalide");

                let referrerData = null;
                if (referralCode) {
                    referrerData = await Utils.checkReferralCode(referralCode);
                    if (!referrerData) throw new Error("Code de parrainage invalide");
                }

                const email = `${telephone}@temp.com`;
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const newReferralCode = Utils.generateReferralCode();

                await set(ref(db, `users/${user.uid}`), {
                    username,
                    email,
                    phoneNumber: telephone,
                    balance: 0,
                    referralCode: newReferralCode,
                    referredBy: referrerData?.userId || null,
                    createdAt: Date.now()
                });

                if (referrerData?.userId) {
                    const referrerRef = ref(db, `users/${referrerData.userId}/balance`);
                    const currentBalanceSnap = await get(referrerRef);
                    const currentBalance = currentBalanceSnap.exists() ? currentBalanceSnap.val() : 0;
                    await set(referrerRef, currentBalance + 10);
                }

                Utils.showSuccess("signupSuccess", "Compte cr√©√© avec succ√®s ! Redirection...");
                setTimeout(() => window.location.href = "accueil.html", 1500);

            } catch (error) {
                console.error("Erreur:", error);
                Utils.showError("signupError", error.message);
            }
        }

        static async handleLogin(event) {
            event.preventDefault();
            Utils.clearMessages();

            try {
                const telephone = document.getElementById("loginTelephone").value.trim();
                const password = document.getElementById("loginPassword").value;

                if (!telephone || !password) throw new Error("Veuillez remplir tous les champs");

                const email = `${telephone}@temp.com`;
                await signInWithEmailAndPassword(auth, email, password);
                window.location.href = "accueil.html";

            } catch (error) {
                console.error("Erreur de connexion:", error);
                Utils.showError("loginError", "Num√©ro ou mot de passe incorrect");
            }
        }

        static async handleReferralCodeInput() {
            const referralInput = document.getElementById('referralCode');
            const code = referralInput.value.trim().toUpperCase();

            if (!code) {
                Utils.updateReferralStatus(true, '');
                return;
            }

            try {
                const referrerData = await Utils.checkReferralCode(code);
                if (referrerData) {
                    Utils.updateReferralStatus(true, `Code valide ! Parrain: ${referrerData.username}`);
                } else {
                    Utils.updateReferralStatus(false, 'Code de parrainage invalide');
                }
            } catch {
                Utils.updateReferralStatus(false, 'Erreur de v√©rification du code');
            }
        }

        static handleReferralCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const referralCode = urlParams.get('ref');
            const referralInput = document.getElementById('referralCode');
            if (referralInput && referralCode) {
                referralInput.value = referralCode.toUpperCase();
                FormManager.handleReferralCodeInput();
            }
        }
    }

    function debounce(func, wait) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    }

    async function calculateRecharges(userId) {
        try {
            const snapshot = await get(ref(db, 'transactions'));
            if (!snapshot.exists()) return { total: 0, count: 0 };

            let totalAmount = 0, count = 0;
            snapshot.forEach(child => {
                const t = child.val();
                if (t.userId === userId && t.status === 'success') {
                    totalAmount += parseFloat(t.amount) || 0;
                    count++;
                }
            });
            return { total: totalAmount, count };
        } catch (error) {
            console.error("Erreur recharges:", error);
            return { total: 0, count: 0 };
        }
    }

    function calculateTotalVIPRevenue(userId) {
        const invRef = ref(db, `investments/${userId}`);
        onValue(invRef, snapshot => {
            const investments = snapshot.val();
            let totalRevenue = 0;
            if (investments) {
                Object.values(investments).forEach(inv => {
                    if (inv.status === 'active' && inv.totalCollected) totalRevenue += inv.totalCollected;
                });
            }
            Utils.updateBalanceDisplay('total-revenue', totalRevenue);
        });
    }

    function calculateTotalWithdrawals(userId) {
        const refW = ref(db, `users/${userId}/withdrawalHistory`);
        onValue(refW, snapshot => {
            const history = snapshot.val();
            let total = 0;
            let count = 0;
            if (history) {
                const arr = Object.values(history);
                total = arr.reduce((sum, w) => sum + (w.amount || 0), 0);
                count = arr.length;
            }
            Utils.updateBalanceDisplay('total-withdrawals', total);
            
            const countEl = document.getElementById('withdrawal-count');
            if (countEl) countEl.textContent = `${count} retrait${count === 1 ? '' : 's'}`;
        });
    }

    async function updateAllStats(userId) {
        const recharges = await calculateRecharges(userId);
        Utils.updateBalanceDisplay('total-recharge', recharges.total);
        
        const countEl = document.getElementById('recharge-count');
        if(countEl) countEl.textContent = `${recharges.count} recharge${recharges.count === 1 ? '' : 's'}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const signupForm = document.getElementById("signupFormData");
        const loginForm = document.getElementById("loginFormData");
        const referralInput = document.getElementById("referralCode");

        if (signupForm) signupForm.addEventListener("submit", FormManager.handleSignup);
        if (loginForm) loginForm.addEventListener("submit", FormManager.handleLogin);
        if (referralInput) referralInput.addEventListener("input", debounce(FormManager.handleReferralCodeInput, 500));

        FormManager.handleReferralCodeFromURL();

        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                navItems.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
                const page = this.dataset.page;
                console.log('Navigation vers:', page);
            });
        });

        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Erreur d√©connexion:', error);
                }
            });
        }
    });

    onAuthStateChanged(auth, async (user) => {
        if(user){
            currentUser = user;
            const userRef = ref(db, `users/${user.uid}`);
            onValue(userRef, snapshot => {
                const data = snapshot.val();
                Utils.updateUserDisplay(data);
                Utils.updateBalanceDisplay('main-balance', data?.balance || 0);
            });

            calculateTotalVIPRevenue(user.uid);
            calculateTotalWithdrawals(user.uid);
            await updateAllStats(user.uid);
        } else {
            currentUser = null;
            Utils.updateUserDisplay(null);
            
            ['main-balance', 'total-recharge', 'total-withdrawals', 'total-revenue'].forEach(id => {
                Utils.updateBalanceDisplay(id, 0);
            });
            
            const rechargeCountEl = document.getElementById('recharge-count');
            const withdrawalCountEl = document.getElementById('withdrawal-count');
            if (rechargeCountEl) rechargeCountEl.textContent = '0 recharge';
            if (withdrawalCountEl) withdrawalCountEl.textContent = '0 retrait';

            setTimeout(() => {
                if (window.location.pathname.includes('accueil')) {
                    window.location.href = 'login.html';
                }
            }, 1000);
        }
    });
</script>
</body>
</html>
