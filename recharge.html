<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NESTCAFE - Recharge S√©curis√©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5ebe0, #ecddd0); padding: 20px; }
        h2 { text-align: center; margin-bottom: 15px; color: #8B4513; font-size: 24px; }

        .form-card { background: #fff; border-radius: 14px; padding: 20px; box-shadow: 0 4px 15px rgba(139,69,19,0.1); max-width: 500px; margin: 0 auto; border: 1px solid #d2b48c; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }

        .operators-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 10px; margin-bottom: 10px; }
        .operator-option { display: none; }
        .operator-label {
            display: flex; flex-direction: column; align-items: center; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease; background: #fafafa; font-size: 12px;
        }
        .operator-option:checked + .operator-label { border-color: #8B4513; background: #fff8f0; }
        .operator-logo { width: 45px; height: 45px; margin-bottom: 6px; }

        input[type="tel"], input[type="number"] {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; background: #fafafa;
        }
        input:focus { outline: none; border-color: #8B4513; background: #fff; box-shadow: 0 0 0 3px rgba(139,69,19,0.1); }

        .quick-amounts { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
        .quick-amount-btn {
            padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: #fafafa; cursor: pointer; font-size: 12px;
            color: #666; font-weight: 500; transition: all 0.2s ease;
        }
        .quick-amount-btn:hover { border-color: #8B4513; transform: scale(1.05); }
        .quick-amount-btn.selected { background: linear-gradient(135deg, #d2691e, #8B4513); color: #fff; border-color: #8B4513; }

        .error-message { color: #f44336; font-size: 12px; margin-top: 5px; opacity: 0; transition: opacity 0.2s ease; }

        .submit-btn {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #d2691e, #8B4513); color: #fff; border: none; border-radius: 10px;
            font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: all 0.3s;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(139,69,19,0.3); }

        .loading {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); justify-content: center; align-items: center; z-index: 1000;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f0f0f0; border-top: 4px solid #8B4513; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 10px; color: #fff;
            display: none; z-index: 1001; box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 13px;
        }
        .notification.success { background: #4CAF50; }
        .notification.error-notification { background: #f44336; }
    </style>
</head>
<body>
    <h2>‚òï Recharge NESTCAFE</h2>

    <div class="form-card">
        <form id="rechargeForm">
            <div class="form-group">
                <label>S√©lectionnez votre op√©rateur</label>
                <div class="operators-grid">
                    <!-- Op√©rateurs locaux -->
                    <div>
                        <input type="radio" name="operator" value="mtn" id="mtn" class="operator-option">
                        <label for="mtn" class="operator-label"><span class="operator-logo">üì∂</span><span class="operator-name">MTN</span></label>
                    </div>
                    <div>
                        <input type="radio" name="operator" value="moov" id="moov" class="operator-option">
                        <label for="moov" class="operator-label"><span class="operator-logo">üì∂</span><span class="operator-name">Moov</span></label>
                    </div>
                    <div>
                        <input type="radio" name="operator" value="orange" id="orange" class="operator-option">
                        <label for="orange" class="operator-label"><span class="operator-logo">üì∂</span><span class="operator-name">Orange</span></label>
                    </div>
                    <div>
                        <input type="radio" name="operator" value="wave" id="wave" class="operator-option">
                        <label for="wave" class="operator-label"><span class="operator-logo">üì∂</span><span class="operator-name">Wave</span></label>
                    </div>

                    <!-- Op√©rateurs hors Afrique -->
                    <div>
                        <input type="radio" name="operator" value="paypal" id="paypal" class="operator-option">
                        <label for="paypal" class="operator-label"><span class="operator-logo">üí≥</span><span class="operator-name">PayPal</span></label>
                    </div>
                    <div>
                        <input type="radio" name="operator" value="skrill" id="skrill" class="operator-option">
                        <label for="skrill" class="operator-label"><span class="operator-logo">üåê</span><span class="operator-name">Skrill</span></label>
                    </div>
                    <div>
                        <input type="radio" name="operator" value="wise" id="wise" class="operator-option">
                        <label for="wise" class="operator-label"><span class="operator-logo">üè¶</span><span class="operator-name">Wise</span></label>
                    </div>
                </div>
                <div id="operatorError" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="phone">Num√©ro de t√©l√©phone</label>
                <input type="tel" id="phone" placeholder="Ex: 0123456789" required>
                <div id="phoneError" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="amount">Montant (FCFA)</label>
                <input type="number" id="amount" min="100" placeholder="Montant minimum: 100 FCFA" required>
                <div class="quick-amounts">
                    <button type="button" class="quick-amount-btn" data-amount="5500">5500</button>
                    <button type="button" class="quick-amount-btn" data-amount="10500">10500</button>
                    <button type="button" class="quick-amount-btn" data-amount="25000">25000</button>
                    <button type="button" class="quick-amount-btn" data-amount="50000">50000</button>
                </div>
                <div id="amountError" class="error-message"></div>
            </div>

            <button type="submit" class="submit-btn">Continuer</button>
        </form>
    </div>

    <div class="loading"><div class="spinner"></div></div>
    <div id="notification" class="notification"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATz_ogu08DUoKSYKy6t2cHWdleUD-Fbrk",
            authDomain: "schweppes-15df3.firebaseapp.com",
            databaseURL: "https://schweppes-15df3-default-rtdb.firebaseio.com",
            projectId: "schweppes-15df3",
            storageBucket: "schweppes-15df3.firebasestorage.app",
            messagingSenderId: "1011077098372",
            appId: "1:1011077098372:web:64f9ad3a8e93f68c070bd1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('rechargeForm');
            const phoneInput = document.getElementById('phone');
            const amountInput = document.getElementById('amount');
            const phoneError = document.getElementById('phoneError');
            const amountError = document.getElementById('amountError');
            const operatorOptions = document.querySelectorAll('.operator-option');
            const quickAmountBtns = document.querySelectorAll('.quick-amount-btn');
            const loading = document.querySelector('.loading');
            const notification = document.getElementById('notification');

            const operatorNumbers = {
                'mtn':'0585842493','moov':'ecrivez au service client','orange':'√©criver au service client','wave':'0778191650',
                'usdt':'TArN5XsrxyhtuzxwKQiWNTBsmMm9Brkim9'
            };

            const blockedOperators = ['paypal','skrill','wise'];

            const showLoading = () => { if(loading) loading.style.display='flex'; }
            const hideLoading = () => { if(loading) loading.style.display='none'; }
            const showNotification = (msg,type='success') => {
                if(!notification) return;
                notification.textContent = msg;
                notification.className = `notification ${type}`;
                notification.style.display='block';
                setTimeout(()=>notification.style.display='none',5000);
            };
            const showError = (id,msg) => { const el=document.getElementById(id); if(el){ el.textContent=msg; el.style.opacity='1'; } };
            const clearErrors = () => { phoneError.textContent=''; phoneError.style.opacity='0'; amountError.textContent=''; amountError.style.opacity='0'; document.getElementById('operatorError').textContent=''; document.getElementById('operatorError').style.opacity='0'; };

            const validateForm = (operator, phone, amount) => {
                clearErrors();
                let isValid = true;
                if(!operator){ showError('operatorError','Veuillez s√©lectionner un op√©rateur'); isValid=false; }
                if(blockedOperators.includes(operator)){ showNotification("L'Afrique n'est pas autoris√©e √† cet op√©rateur. Veuillez utiliser les op√©rateurs locaux.", "error-notification"); isValid=false; }
                if(amount<100){ showError('amountError','Le montant minimum est de 100 FCFA'); isValid=false; }
                return isValid;
            };

            operatorOptions.forEach(option=>{
                option.addEventListener('change', ()=>{
                    if(blockedOperators.includes(option.value)){
                        showNotification("L'Afrique n'est pas autoris√©e √† cet op√©rateur. Veuillez utiliser les op√©rateurs locaux.","error-notification");
                        option.checked=false;
                    }
                });
            });

            quickAmountBtns.forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    quickAmountBtns.forEach(b=>b.classList.remove('selected'));
                    btn.classList.add('selected');
                    amountInput.value=btn.getAttribute('data-amount');
                });
            });

            if(amountInput) amountInput.addEventListener('input', ()=>quickAmountBtns.forEach(b=>b.classList.remove('selected')));
            if(phoneInput) phoneInput.addEventListener('input',()=>{ phoneError.textContent=''; phoneError.style.opacity='0'; });

            onAuthStateChanged(auth,(user)=>{
                if(!user){ showNotification('Veuillez vous connecter pour continuer','error-notification'); setTimeout(()=>window.location.href='login.html',2000); }
            });

            if(form) form.addEventListener('submit', async (e)=>{
                e.preventDefault();
                const user = auth.currentUser;
                if(!user){ showNotification('Veuillez vous connecter pour continuer','error-notification'); return; }

                const operator = document.querySelector('input[name="operator"]:checked')?.value;
                const phone = phoneInput.value;
                const amount = parseInt(amountInput.value)||0;

                if(!validateForm(operator,phone,amount)) return;

                showLoading();

                try{
                    const rechargeData = {
                        operator, phone, amount,
                        operatorNumber: operatorNumbers[operator]||'N/A',
                        date: new Date().toISOString(),
                        userId: user.uid,
                        userEmail: user.email,
                        status: 'pending'
                    };
                    sessionStorage.setItem('rechargeData', JSON.stringify(rechargeData));
                    const rechargeRef = ref(db, `recharges/${user.uid}/${Date.now()}`);
                    await set(rechargeRef,rechargeData);
                    window.location.href='confirmation.html';
                }catch(error){
                    console.error('Erreur:',error);
                    showNotification('Une erreur est survenue. Veuillez r√©essayer.','error-notification');
                }finally{ hideLoading(); }
            });
        });
    </script>
</body>
</html>
